<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>glassslipper</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="desktop">
    <!-- Icons -->
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window1', './folder1/folder1.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/bomb.png" alt="Folder Icon" />
      <div class="icon-label">infires man</div>
    </div>
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window2', './folder2/folder2.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/folder.webp" alt="Folder Icon" />
      <div class="icon-label">English</div>
    </div>
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window5', './folder5/folder5.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/folder.webp" alt="Folder Icon" />
      <div class="icon-label">Maths</div>
    </div>
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window3', './folder3/folder3.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/ie-icon-16.png" alt="Folder Icon" />
      <div class="icon-label">Internet Explorer</div>
    </div>
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window4', './folder4/folder4.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/itune.png" alt="Folder Icon" />
      <div class="icon-label">iTunes</div>
    </div>
    <div class="icon" onclick="highlightIcon(this)" ondblclick="toggleWindow('window6', './folder6/folder6.html')">
      <img src="https://lanvi0812.github.io/051120i5/img/pddf.png" alt="Folder Icon" />
      <div class="icon-label">demian.pdf</div>
    </div>

    <!-- Windows -->
    <div id="window1" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        iNfIrEs MaN yEaHH ˚ˋঌ˖
        <button class="close-btn" onclick="closeWindow('window1')">&times;</button>
      </div>
      <div class="window-body" id="window1-content"></div>
    </div>

    <div id="window2" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        English
        <button class="close-btn" onclick="closeWindow('window2')">&times;</button>
      </div>
      <div class="window-body" id="window2-content"></div>
    </div>

    <div id="window3" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        Internet Explorer
        <button class="close-btn" onclick="closeWindow('window3')">&times;</button>
      </div>
      <div class="window-body" id="window3-content"></div>
    </div>

    <div id="window4" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        iTunes
        <button class="close-btn" onclick="closeWindow('window4')">&times;</button>
      </div>
      <div class="window-body" id="window4-content"></div>
    </div>

    <div id="window5" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        Maths
        <button class="close-btn" onclick="closeWindow('window5')">&times;</button>
      </div>
      <div class="window-body" id="window5-content"></div>
    </div>

    <div id="window6" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        demian.pdf
        <button class="close-btn" onclick="closeWindow('window6')">&times;</button>
      </div>
      <div class="window-body" id="window6-content"></div>
    </div>

    <!-- Folder A -->
    <div id="folderAWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        spelling hw.pdf
        <button class="close-btn" onclick="closeWindow('folderAWindow')">&times;</button>
      </div>
      <div class="window-body" id="folderAWindow-content"></div>
    </div>

    <!-- Folder B -->
    <div id="folderBWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        research.doc
        <button class="close-btn" onclick="closeWindow('folderBWindow')">&times;</button>
      </div>
      <div class="window-body" id="folderBWindow-content"></div>
    </div>

    <!-- Folder C -->
    <div id="folderCWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        wk2 hw.doc
        <button class="close-btn" onclick="closeWindow('folderCWindow')">&times;</button>
      </div>
      <div class="window-body" id="folderCWindow-content"></div>
    </div>

    <!-- bangtan -->
    <div id="bangtanWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        bangtann ଘ(੭*ˊᵕˋ)੭* ੈ♡‧₊˚
        <button class="close-btn" onclick="closeWindow('bangtanWindow')">&times;</button>
      </div>
      <div class="window-body" id="bangtanWindow-content"></div>
    </div>

    <!-- aesthetic -->
    <div id="aestheticWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        aesthetic ✧˖°
        <button class="close-btn" onclick="closeWindow('aestheticWindow')">&times;</button>
      </div>
      <div class="window-body" id="aestheticWindow-content"></div>
    </div>

    <!-- Fullscreen Preview -->
    <div class="fullscreen-preview" id="fullscreenPreview" onclick="closePreview(event)">
      <img id="fullscreenImg" src="" alt="Preview Image" />
      <span class="close-fullscreen" onclick="closePreview(event)">&times;</span>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
      <div class="taskbar-left">
        <div class="taskbar-app start-button" onclick="toggleStartMenu()">⬅</div>
        <!-- Clear overrideDone upon logging out, then navigate to index.html -->
        <div class="taskbar-app" onclick="localStorage.removeItem('overrideDone'); toggleWindow('screenTimeWindow')">Screen Time</div>
      </div>
      <div class="clock" id="clock">18:00</div>
      <div id="startMenu" class="start-menu" style="display: none;">
        <ul>
          <li class="active-option"
              onclick="localStorage.removeItem('overrideDone'); href='https://lanvi0812.github.io/051120i5/'">
            Log Out
          </li>
        </ul>
      </div>
    </div>

    <!-- Screen Time Window -->
    <div id="screenTimeWindow" class="window draggable resizable" style="display:none;">
      <div class="window-header">
        Screen Time
        <button class="close-btn" id="closeScreenTimeBtn" onclick="closeWindow('screenTimeWindow')">&times;</button>
      </div>
      <div class="window-body">
        <p>You have <span id="timeLeftText">7 minutes 0 seconds</span> left of using the desktop today.</p>
        <a href="#" id="extendLink">Extend your time limit?</a>
      </div>
    </div>

    <!-- Error Popup -->
    <div id="errorPopup" class="popup-overlay" style="display: none;">
      <div class="popup-box">
        <p>Error: You don't have access to this function.</p>
        <button onclick="closeErrorPopup()">OK</button>
      </div>
    </div>

    <!-- Override Popup -->
    <div id="overridePopup" style="display:none;">
      <div class="popup-box">
        <p>Override?</p>
        <button id="overrideOkBtn">OK</button>
      </div>
    </div>

    <!-- "0 seconds left" fixed popup -->
    <div id="zeroTimePopup" style="display:none;">
      <div class="popup-box">
        <p>You have 0 seconds left</p>
      </div>
    </div>

    <!-- Continue link -->
    <a href="https://www.google.com" id="continueLink" style="display:none;">continue?</a>
  </div>

  <script>
    // If this page was loaded immediately after index.html, clear any previous override state
    if (document.referrer.endsWith('https://lanvi0812.github.io/051120i5/')) {
      localStorage.removeItem('overrideDone');
    }

    let zIndexCounter = 1000;

    // Track whether override sequence has already run
    const wasOverridden = localStorage.getItem('overrideDone') === 'true';

    // Only start countdown if not already overridden
    let totalSeconds = wasOverridden ? 0 : 7 * 60;

    function bringToFront(win) {
      zIndexCounter++;
      win.style.zIndex = zIndexCounter;
    }

    function toggleWindow(id, contentUrl = null) {
      const win = document.getElementById(id);
      if (!win) return;
      if (win.style.display === 'block') {
        bringToFront(win);
      } else {
        win.style.top = Math.floor(Math.random() * 300 + 50) + 'px';
        win.style.left = Math.floor(Math.random() * 500 + 50) + 'px';
        win.style.display = 'block';
        bringToFront(win);
        dragElement(win);
        if (contentUrl) {
          const contentDiv = document.getElementById(id + '-content');
          if (contentDiv) {
            fetch(contentUrl)
              .then(res => res.text())
              .then(html => contentDiv.innerHTML = html);
          }
        }
      }
    }

    function closeWindow(id) {
      const win = document.getElementById(id);
      if (win) win.style.display = 'none';
    }

    function dragElement(elmnt) {
      const header = elmnt.querySelector('.window-header');
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      if (header) header.onmousedown = dragMouseDown;
      function dragMouseDown(e) {
        e.preventDefault();
        bringToFront(elmnt);
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }
      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = elmnt.offsetTop - pos2 + "px";
        elmnt.style.left = elmnt.offsetLeft - pos1 + "px";
      }
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    function openPreview(src) {
      const preview = document.getElementById('fullscreenPreview');
      const img = document.getElementById('fullscreenImg');
      img.src = src;
      preview.style.display = 'flex';
      bringToFront(preview);
    }

    function closePreview(event) {
      if (
        !event ||
        event.target.id === 'fullscreenPreview' ||
        event.target.classList.contains('close-fullscreen')
      ) {
        document.getElementById('fullscreenPreview').style.display = 'none';
        document.getElementById('fullscreenImg').src = '';
      }
    }

    // clock set up
    let fakeTime = new Date();
    fakeTime.setHours(18, 0, 0, 0);
    function updateFakeClock() {
      fakeTime.setMinutes(fakeTime.getMinutes() + 1);
      const h = fakeTime.getHours().toString().padStart(2, '0');
      const m = fakeTime.getMinutes().toString().padStart(2, '0');
      document.getElementById('clock').textContent = `${h}:${m}`;
    }
    updateFakeClock();
    setInterval(updateFakeClock, 10000);

    // screen time count down
    let countdownInterval;

    function updateCountdown() {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      document.getElementById("timeLeftText").textContent =
        `${minutes} minute${minutes !== 1 ? 's' : ''} ${seconds} second${seconds !== 1 ? 's' : ''}`;

      // At 15 seconds, disable close button
      if (totalSeconds === 15) {
        const closeBtn = document.getElementById('closeScreenTimeBtn');
        closeBtn.onclick = null;
        closeBtn.style.opacity = '0.2';
        closeBtn.style.pointerEvents = 'none';
      }

      // When countdown hits zero, show override popup
      if (totalSeconds === 0) {
        clearInterval(countdownInterval);
        document.getElementById('overridePopup').style.display = 'flex';
        bringToFront(document.getElementById('overridePopup'));
      }

      if (totalSeconds > 0) totalSeconds--;
    }

    if (!wasOverridden) {
      countdownInterval = setInterval(updateCountdown, 1000);
    } else {
      // If override already done, show override immediately
      document.getElementById('overridePopup').style.display = 'flex';
      bringToFront(document.getElementById('overridePopup'));
    }

    // “Extend your time limit?” → show error popup again
    document.getElementById('extendLink').addEventListener('click', function(e) {
      e.preventDefault();
      showErrorPopup();
    });

    function showErrorPopup() {
      document.getElementById('errorPopup').style.display = 'flex';
      bringToFront(document.getElementById('errorPopup'));
    }
    function closeErrorPopup() {
      document.getElementById('errorPopup').style.display = 'none';
    }

    // Override popup OK: clone “OK” buttons then reload
    document.getElementById('overrideOkBtn').addEventListener('click', function() {
      const popupBox = document.querySelector('#overridePopup .popup-box');
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const dup = popupBox.cloneNode(true);
          const x = Math.random() * (window.innerWidth - 200);
          const y = Math.random() * (window.innerHeight - 100);
          dup.style.position = 'fixed';
          dup.style.top = `${y}px`;
          dup.style.left = `${x}px`;
          document.body.appendChild(dup);
        }, i * 100);
      }
      setTimeout(() => {
        localStorage.setItem('overrideDone', 'true');
        location.reload();
      }, 1500);
    });

    // post-override behaviour
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('overrideDone') === 'true') {
        animateClockToZero();
        document.getElementById('zeroTimePopup').style.display = 'flex';
        bringToFront(document.getElementById('zeroTimePopup'));
        slowlyEraseCssRules();
        slowlyRemovePageElements();
      }
    });

    function animateClockToZero() {
      const clockElem = document.getElementById('clock');
      const parts = clockElem.textContent.split(':');
      let currentSeconds = parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60;
      const totalSteps = 35;
      let step = 0;
      const interval = setInterval(() => {
        step++;
        const newSec = Math.max(0, Math.ceil(currentSeconds * (totalSteps - step) / totalSteps));
        const h = Math.floor(newSec / 3600).toString().padStart(2, '0');
        const m = Math.floor((newSec % 3600) / 60).toString().padStart(2, '0');
        clockElem.textContent = `${h}:${m}`;
        if (step >= totalSteps) {
          clearInterval(interval);
          clockElem.textContent = '00:00';
        }
      }, 1000);
    }

    function slowlyEraseCssRules() {
      const sheets = Array.from(document.styleSheets).filter(ss => {
        try { return ss.cssRules && ss.cssRules.length > 0; } catch { return false; }
      });
      // Speed up deletion: now remove one rule every 1 second
      const eraseInterval = setInterval(() => {
        if (sheets.length === 0) {
          clearInterval(eraseInterval);
          injectBasicCss();
          return;
        }
        const sheetIdx = Math.floor(Math.random() * sheets.length);
        const ss = sheets[sheetIdx];
        const rules = ss.cssRules;
        if (rules.length === 0) {
          sheets.splice(sheetIdx, 1);
          return;
        }
        const ruleIdx = Math.floor(Math.random() * rules.length);
        ss.deleteRule(ruleIdx);
        if (ss.cssRules.length === 0) {
          sheets.splice(sheetIdx, 1);
        }
      }, 1000);
    }

    function injectBasicCss() {
      const style = document.createElement('style');
      const randFS = Math.floor(Math.random() * 20 + 10) + 'px';
      const randM = Math.floor(Math.random() * 30) + 'px';
      style.textContent = `
        html, body { font-size: ${randFS}; margin: ${randM}; }
        * { transition: none !important; }
      `;
      document.head.appendChild(style);
    }

    function slowlyRemovePageElements() {
      const container = document.querySelector('.desktop');
      let children = Array.from(container.children).filter(el =>
        !['overridePopup', 'zeroTimePopup', 'continueLink'].includes(el.id)
      );
      let idx = 0;
      const removalInterval = setInterval(() => {
        if (idx < children.length) {
          children[idx].remove();
          idx++;
        } else {
          clearInterval(removalInterval);
          document.getElementById('continueLink').style.display = 'block';
        }
      }, 7000);
    }

    function showDeny() {
      const existing = document.getElementById('denyPopup');
      if (existing) return;
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.id = 'denyPopup';
      popup.innerHTML = `
        <div class="popup-box">
          <p>You haven't unlocked that yet!</p>
          <button onclick="document.getElementById('denyPopup').remove()">Close</button>
        </div>
      `;
      document.body.appendChild(popup);
      bringToFront(popup);
    }

    function showDenyOld() {
      const existing = document.getElementById('denyOldPopup');
      if (existing) return;
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.id = 'denyOldPopup';
      popup.innerHTML = `
        <div class="popup-box">
          <p>Your're too old to listen to her!</p>
          <button onclick="document.getElementById('denyOldPopup').remove()">Close</button>
        </div>
      `;
      document.body.appendChild(popup);
      bringToFront(popup);
    }

    function highlightIcon(el) {
      document.querySelectorAll('.icon').forEach(icon => {
        icon.classList.remove('highlighted');
      });
      el.classList.add('highlighted');
      function removeHighlight(e) {
        if (!el.contains(e.target)) {
          el.classList.remove('highlighted');
          document.removeEventListener('click', removeHighlight);
        }
      }
      document.addEventListener('click', removeHighlight);
    }

    function highlightFolder(el) {
      document.querySelectorAll('.folder').forEach(folder => {
        folder.classList.remove('highlighted');
      });
      el.classList.add('highlighted');
      function removeHighlight(e) {
        if (!el.contains(e.target)) {
          el.classList.remove('highlighted');
          document.removeEventListener('click', removeHighlight);
        }
      }
      document.addEventListener('click', removeHighlight);
    }

    function toggleStartMenu() {
      const menu = document.getElementById('startMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
  </script>
</body>
</html>
